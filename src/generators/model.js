#!/usr/bin/env node

// Arguments validator.
const { ensure } = require('nodester/validators/arguments');

// Utils:
const {
	exposeGeneratorTools,
	lowercaseFirstLetter
} = require('./common');

const inflection = require('inflection');


module.exports = function generateNewModel(nodesterConfigs, modelName) {
	try {
		ensure(modelName, 'string,required', 'modelName');

		const {
			dirs,
			fs,
			Path
		} = exposeGeneratorTools(nodesterConfigs);

		let modelCreated = false;
		let controllerCreated = false;
		let facadeCreated = false;
		
		const modelNameLowercased = lowercaseFirstLetter(modelName);


		// Write to /models directory, if doesn't exist:
		const modelPath = Path.join(dirs.models, `${ modelName }.js`);
		const modelAlreadyExists = fs.existsSync(modelPath);

		if (modelAlreadyExists === false) {
			// Create it:
			fs.writeFileSync(
				modelPath,
				_modelContent(modelName, modelNameLowercased)
			);

			modelCreated = true;
		}


		// Get plural name:
		const modelNamePlural = inflection.pluralize(modelName);
		const modelNamePluralLowercased = lowercaseFirstLetter(modelNamePlural);


		// Write to /controllers directory, if doesn't exist:
		const controllerPath = Path.join(dirs.controllers, `${ modelNamePlural }.controller.js`);
		const controllerAlreadyExists = fs.existsSync(controllerPath);

		if (controllerAlreadyExists === false) {
			// Create it:
			const controllerName = `${ modelNamePlural }Controller`;
			fs.writeFileSync(
				controllerPath,
				_controllerContent(controllerName, modelNamePluralLowercased)
			);

			controllerCreated = true;
		}


		// Write to /facades directory, if doesn't exist:
		const facadePath = Path.join(dirs.facades, `${ modelNamePluralLowercased }.js`);
		const facadeAlreadyExists = fs.existsSync(facadePath);
		
		if (facadeAlreadyExists === false) {
			// Create it:
			fs.writeFileSync(
				facadePath,
				_facadeContent(modelName, modelNameLowercased, modelNamePlural)
			);

			facadeCreated = true;
		}

		console.info(`Model ${ modelName }:\n`)
		console.info(`• Model created:`, modelCreated);
		if (modelCreated === false && modelAlreadyExists) {
			console.info(`└ Reason: model already exists.\n`);
		}

		console.info(`• Controller created:`, controllerCreated);
		if (controllerCreated === false && controllerAlreadyExists) {
			console.info(`└ Reason: controller already exists.\n`);
		}

		console.info(`• Facade created:`, facadeCreated);
		if (facadeCreated === false && facadeAlreadyExists) {
			console.info(`└ Reason: facade already exists.\n`);
		}
		
		// End.
		process.exit(0);
	}
	catch(error) {
		console.error('Fatal Error', error);
	}
};


function _modelContent(modelName, modelNameLowercased) {
	return (
`// ORM.
const DatabaseConnection = require('#db');
// Definition (nodester).
const defineModel = require('nodester/models/define');


const ${ modelNameLowercased } = defineModel(DatabaseConnection, '${ modelName }',
	(DataTypes) => ({
		id: {
			type: DataTypes.INTEGER.UNSIGNED,
			allowNull: false,
			primaryKey: true,
			autoIncrement: true,
			_autoGenerated: true
		},
	}),
	{
		// Allow only "soft" delete.
		paranoid: true
	}
);

// Hooks:
${ modelNameLowercased }.associate = (models) => {
}

module.exports = ${ modelNameLowercased };
`
	);
}

function _controllerContent(controllerName, modelNamePluralLowercased) {
	return (
`const {
	withDefaultCRUD,
	withDefaultErrorProcessing
} = require('nodester/controllers/mixins');

const ${ modelNamePluralLowercased }Facade = require('#facades/${ modelNamePluralLowercased }');


module.exports = function ${ controllerName }() {
	withDefaultCRUD(this, {
		facade: ${ modelNamePluralLowercased }Facade
	});
	withDefaultErrorProcessing(this);
}
`
	);
}

function _facadeContent(modelName, modelNameLowercased, modelNamePlural) {
	return(
`const {
	withDefaultCRUD
} = require('nodester/facades/mixins');

// Model.
const ${ modelNameLowercased } = require('#models/${ modelName }');


module.exports = function ${ modelNamePlural }Facade() {
	withDefaultCRUD(this, {
		model: ${ modelNameLowercased }
	});
}
`
	);
}
